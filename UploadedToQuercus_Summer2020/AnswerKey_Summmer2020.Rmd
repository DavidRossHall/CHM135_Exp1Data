---
output:
  #tufte::tufte_html: default
  tufte::tufte_handout: default
params:
  
  file: "Toronto_60410_2018_Day202to208.csv"
#title : "Test" 
title: "`r params$file`"
header-includes:
  - \usepackage{float}
---

The results below are what the student results should look like for the `r params$file` dataset used in CHM 135 Experiment 1.

```{r, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, fig.height = 1.25, fig.cap= "Time series of pollutant concentration."}
library(ggplot2)
library(ggpubr)
library(ggpmisc)
library(dplyr)
library(tidyr)
library(openxlsx)

data <- read.csv(params$file, header = TRUE)

data <- data %>%
  mutate(time = convertToDateTime(data$Date, origin = "1900-01-01")) %>%
  filter(O3 != -999) %>%
  filter(NO2 != -999) %>%
  mutate(OX = NO2 + O3)

### Making data tidyR friendly --------------------------------------------------
dataCol <- data %>%
  select(-c("Date", "temperature")) %>%
  pivot_longer(-time, names_to = "pollutant", values_to = "concentration")
### -----------------------------------------------------------------------------


### Time series plot of NO2, O3, and OX ------------------------------------------
a <- ggplot(data = dataCol, aes(x = time, y = concentration, color = pollutant)) +
  geom_line(size = 1) +
  theme_classic() +
   theme(text = element_text(size = 10),
         legend.position = "right") +
  ylab(bquote('Conc., ppb')) +
  xlab(bquote('Time')) 
### -----------------------------------------------------------------------------

a

```

```{r, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, fig.cap= "Correlation plot of O3 vs. NO2; the equation of the line is dislayed in the lower left corner.", fig.height = 1.5}
library(ggplot2)
library(ggpubr)
library(ggpmisc)
library(dplyr)
library(tidyr)
library(openxlsx)
library(RcppRoll)

data <- read.csv(params$file, header = TRUE)

data <- data %>%
  mutate(time = convertToDateTime(data$Date, origin = "1900-01-01")) %>%
  filter(O3 != -999) %>%
  filter(NO2 != -999) %>%
  mutate(OX = NO2 + O3)

formula <- y ~ x ### Need to keep this so LM regression appears on plot

### Correlation plot with Linear regression and equation -------------------------
b <- ggplot(data = data, aes(x = NO2, y = O3)) +
  geom_point(size = 0.5) + 
  scale_x_continuous(expand = c(0, 0), limits = c(0, NA)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, NA)) +
  theme_classic() +
  theme(text = element_text(size = 10))+
  xlab(bquote('Conc.' ~NO[2]~', ppb')) +
  ylab(bquote('Conc.' ~O[3]~', ppb')) +
  geom_smooth(method = "lm", formula = formula, se = FALSE) +
  stat_poly_eq(aes(label =  paste(stat(eq.label), stat(rr.label), sep = "*\", \"*")),
               formula = formula, rr.digits = 4 , parse = TRUE, label.y = 0.05, size = 3)

b

```


```{r, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE}
library(ggpubr)
library(ggpmisc)
library(dplyr)
library(tidyr)
library(RcppRoll)
library(openxlsx)
library(kableExtra)

data <- read.csv(params$file, header = TRUE)

data <- data %>%
  mutate(time = convertToDateTime(data$Date, origin = "1900-01-01")) %>%
  filter(O3 != -999) %>%
  filter(NO2 != -999) %>%
  mutate(OX = NO2 + O3)


### Making data tidyR friendly for 1 hr --------------------------------------------------
dataCol <- data %>%
  select(-c("Date", "temperature")) %>%
  pivot_longer(-time, names_to = "pollutant", values_to = "concentration")
### -----------------------------------------------------------------------------

### Summary Stats for 1hr and 8 hr pollutant concentrations ------------------------------
stable <- desc_statby(dataCol, measure.var = "concentration", grps = "pollutant") %>%
  select(c("pollutant", "mean", "sd", "median", "min", "max"))



knitr::kable(stable, 
             align = "lrrrrr",
             caption = "Summary statistics for 1 hr and 8hr concentration of pollutants, all concentrations are in ppb.",
             digits = c(0,1,1,0,0,0),
             format = "latex",
             booktabs = T
            ) 
### -----------------------------------------------------------------------------

### 8hr rolling average data for table
data$NO2_8hr <- roll_mean(data$NO2, 8, na.rm = TRUE, fill = NA, align = 'right')
data$O3_8hr <- roll_mean(data$O3, 8, na.rm = TRUE, fill = NA, align = 'right')
data$OX_8hr <- roll_mean(data$OX, 8, na.rm = TRUE, fill = NA, align = 'right')

data8hrCol <- data %>%
  select(c("time", "NO2_8hr", "O3_8hr", "OX_8hr")) %>%
  pivot_longer(-time, names_to = "pollutant", values_to = "meanConc_8hr") %>%
  filter(!is.na(meanConc_8hr))
### ------------------------------------------------------------------------------

maxO3 <- which.max(data$O3)
maxO3HighBound <- which.max(data$O3)+7

if(maxO3HighBound > length(data$O3)){
  maxO3LowBound <- length(data$O3)
}

maxO38hr <- data[(maxO3):(maxO3HighBound),] # subset data frame to get time of max NO2 value, and surrounding 8 hr means. 

maxO38hr <- max(maxO38hr$O3_8hr, na.rm = TRUE)

sigFigs = function(x, d=2) sprintf(paste0("%1.",d,"f"), x) 

highest8hrO3 <- sigFigs(maxO38hr)

```

\hfill\break

**Question 13**: The highest 8-hour mean O3 concentration that includes the highest concentration of O3 identified in question 12 is **`r highest8hrO3` ppb**. 


## Notes on results: 

Students are **not** expected to calculate *mean*, *sd*, and *median* of 8 hr averages. If student *sd* values differ slightly from provided *sd* values, they may have used the *STDEV.P* function rather than *STDEV.S* in Excel calculations. Do not substract points, but make a note of it.


